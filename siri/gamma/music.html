<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Siri Music</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
  <style>
    /* General Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background-color: #ecf0f3; overflow-x: hidden; }

    /* Brand & Navigation */
    .brand { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; padding: 15px; display: flex; align-items: center; justify-content: space-between; background-color: #ecf0f3; box-shadow: 9px 9px 16px #d1d9e6, -9px -9px 16px #f9f9f9; }
    .brand-title { font-size: 20px; color: #555; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px; position: relative; }
    .os-version { font-size: 11px; color: rgba(0, 0, 0, 0.3); position: absolute; bottom: -0.1px; left: 90px; white-space: nowrap; }

    .back-button { position: fixed; top: 65px; left: 10px; background-color: #ecf0f3; border: none; padding: 8px 16px; border-radius: 25px; cursor: pointer; display: none; z-index: 1001; transition: transform 0.3s ease, opacity 0.3s ease; font-size: 14px; color: #555; box-shadow: 5px 5px 9px #d1d9e6, -5px -5px 9px #f9f9f9; }
    .back-button:active { transform: scale(0.95); box-shadow: inset 5px 5px 9px #d1d9e6, inset -5px -5px 9px #f9f9f9; }

    /* Main Container */
    .container { max-width: 1200px; margin: 0 auto; padding: 80px 15px 20px; position: relative; /* 컨테이너 기준 위치 설정 */ }

    /* Artist Grid */
    .artists-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; opacity: 1; transition: opacity 0.3s, transform 0.3s; } /* opacity, transform transition 추가 */
    .artists-grid.hidden { opacity: 0; transform: translateY(20px); display: none !important; } /* hidden 클래스 추가 */
    .artist-card { background-color: #ecf0f3; border-radius: 15px; overflow: hidden; box-shadow: 7px 7px 10px #d1d9e6, -7px -7px 10px #f9f9f9; transition: transform 0.2s; cursor: pointer; position: relative; }
    .artist-card:hover { transform: translateY(-3px); box-shadow: 9px 9px 12px #d1d9e6, -9px -9px 12px #f9f9f9; }
    .artist-image { width: 100%; aspect-ratio: 1; object-fit: cover; }
    .artist-name-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.6)); color: #fff; font-size: 1.4em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }

    /* Artist Section */
    .artist-section { display: none; position: absolute; top: 80px; left: 0; width: 100%; padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; } /* position absolute, transition 추가 */
    .artist-section.active { display: block; opacity: 1; transform: translateY(0); } /* active 클래스 추가 */
    .artist-video-container { position: relative; width: 100%; height: 250px; border-radius: 25px; overflow: hidden; box-shadow: 9px 9px 16px #d1d9e6, -9px -9px 16px #f9f9f9; }
    .artist-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
    .artist-video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.4) 90%); pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 15px; }
    .artist-section .artist-info h2 { color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); font-size: 1.6em; }

    /* Albums Grid */
    .albums-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; position: absolute; top: 350px; left: 15px; width: calc(100% - 30px); } /* transition, position absolute, width 추가 */
    .albums-grid.active { display: grid; opacity: 1; transform: translateY(0); } /* active 클래스 추가 */
    .album-card { background-color: #ecf0f3; border-radius: 12px; overflow: hidden; box-shadow: 6px 6px 9px #d1d9e6, -6px -6px 9px #f9f9f9; transition: transform 0.2s; cursor: pointer; }
    .album-card:hover { transform: translateY(-3px); box-shadow: 8px 8px 11px #d1d9e6, -8px -8px 11px #f9f9f9; }
    .album-image { width: 100%; aspect-ratio: 1; object-fit: cover; transition: transform 0.3s ease; /* 애니메이션 속도 조절 */ }
    .album-card.expanded .album-image { transform: scale(1.1); } /* expanded 클래스 추가 및 스타일 정의 */
    .album-info { padding: 10px 15px; }
    .album-number { color: #777; font-size: 0.8em; margin-bottom: 3px; }

    /* Tracks List */
    .tracks-list { display: none; background-color: #ecf0f3; border-radius: 15px; padding: 20px; margin-top: 20px; box-shadow: 7px 7px 10px #d1d9e6, -7px -7px 10px #f9f9f9; overflow-y: auto; opacity: 0; transform: translateY(20px); transition: opacity 0.4s, transform 0.4s; position: absolute; top: 350px; left: 15px; width: calc(100% - 30px); } /* transition, position absolute, width 추가 */
    .tracks-list.active { display: block; opacity: 1; transform: translateY(0); } /* active 클래스 추가 */
    .track-item { display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 10px; }
    .track-item:hover { background-color: #e2e8ec; }
    .track-number { width: 25px; color: #777; font-size: 0.9em; }
    .track-info { flex-grow: 1; font-size: 0.95em; color: #444; }

    /* Mini Player */
    .mini-player { position: fixed; bottom: 15px; right: 15px; background-color: #ecf0f3; border-radius: 12px; padding: 12px; box-shadow: 7px 7px 10px #d1d9e6, -7px -7px 10px #f9f9f9; display: none; align-items: center; gap: 10px; cursor: pointer; z-index: 1000; width: calc(100% - 30px); max-width: 350px; transition: transform 0.3s ease; }
    .mini-player img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; transition: transform 0.5s ease; }
    .mini-player .track-info{ flex-grow: 1; overflow: hidden; }
    .mini-player .track-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; color: #333; }
    .mini-player .artist-name { color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.8em; }
    .player-controls { display: flex; align-items: center; gap: 5px; margin-right: 0px; }

    /* Control Buttons */
    .control-button { background: none; border: none; cursor: pointer; padding: 6px; transition: transform 0.2s; color: #555; }
    .mini-player .control-button { font-size: 18px; }
    .full-player .control-button { font-size: 28px; margin: 0 8px; color: #fff; }
    .control-button:hover { transform: scale(1.1); }

    /* Full Player */
    .full-player { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #a8b8fc; display: none; z-index: 2000; padding: 20px; overflow: hidden; }
    .full-player .back-button { position: absolute; top: 20px; left: 20px; display: block; color: #000; box-shadow: 5px 5px 9px #92a3d8, -5px -5px 9px #c0cffd; }
    .full-player .back-button:active { box-shadow: inset 5px 5px 9px #92a3d8, inset -5px -5px 9px #c0cffd; }
    .full-player-content { display: flex; flex-direction: column;  width: 100%; display: flex; }
    .player-left, .player-right { flex: none; width: 100%; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .player-right { overflow-y: auto; padding-top: 30px; }
    .full-player-album-art { width: 200px; height: 200px; border-radius: 15px; margin-bottom: 15px; transition: transform 0.5s ease, opacity 0.5s ease; opacity: 1; transform: scale(1); }

    /* Progress Bar */
    .progress-container {
        width: 95%;
        max-width: 400px;
        height: 10px;
        background-color: #ecf0f3;
        border-radius: 50px;
        margin: 20px 0;
        cursor: pointer;
        position: relative;
        box-shadow: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #f9f9f9;
        display: flex;
        align-items: center;
    }
    .full-player .progress-container {
        background-color: #ecf0f3;
        box-shadow: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #f9f9f9;
    }

    .progress { height: 100%; background-color: #fff; border-radius: 50px; width: 0; transition: width 0.1s linear; }
    .full-player .progress {
        background-color: #ecf0f3;
    }

    /* Progress Knob */
    .progress-knob {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        background-color: #ecf0f3;
        border-radius: 50%;
        transition: opacity 0.2s ease, transform 0.1s ease;
        box-shadow: 3px 3px 6px #d1d9e6, -3px -3px 6px #f9f9f9;
        pointer-events: none;
    }
    .full-player .progress-knob {
        background-color: #ecf0f3;
        box-shadow: 3px 3px 6px #d1d9e6, -3px -3px 6px #f9f9f9;
    }

    .progress-container:hover .progress-knob,
    .progress-container.dragging .progress-knob { opacity: 1;  }

    .time-display { display: flex; justify-content: space-between; width: 95%; max-width: 400px; color: #eee; font-size: 12px; text-shadow: 0 1px 1px rgba(0,0,0,0.2); color: #fff; }

    /* Lyrics */
   .lyrics-container {
        width: 100%;
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        overflow-y: auto;
        overflow-x: hidden;
        -ms-overflow-style: none;
        scrollbar-width: none;
        max-height: calc(100vh - 450px);
        padding: 10px;
        margin-bottom: 20px;
    }
    .lyrics-container::-webkit-scrollbar { display: none; }

    /* Lyrics Line */
.lyrics-line {
    padding: 8px 10px;
    margin: 5px 0;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease, font-size 0.3s ease;
    opacity: 0.7;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1em;
    color: #eee;
    text-shadow: 0 1px 1px rgba(0,0,0,0.3);
    line-height: 1.4;
    will-change: transform, opacity;
    white-space: pre-line;
}

.lyrics-line.active {
    font-size: 1.2em;
    font-weight: bold;
    opacity: 1;
    transform: scale(1.05) translateY(-3px);
    transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    color: #fff;
    padding: 10px 12px;
    background-color: rgba(255,255,255,0.1);
}
    .lyrics-line:hover { background-color: rgba(255,255,255,0.05); }

    .full-player .track-name, .full-player .artist-name { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); color: white; text-align: center; margin-bottom: 3px; font-size: 1.2em; }

    /* Responsive Design */
    @media (min-width: 768px) {
      /* Larger Screens */
      .brand { padding: 20px; }
      .brand-title { font-size: 24px; gap: 10px; }
      .os-version { font-size: 12px; left: 110px; }
      .back-button { top: 80px; left: 20px; padding: 10px 20px; font-size: 16px; }
      .container { padding: 100px 20px 20px; }
      .artists-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; margin-top: 30px; }
      .artist-card:hover { transform: translateY(-5px); }
      .artist-name-overlay { padding: 15px; font-size: 2em; }
      .artist-section { margin-bottom: 40px; }
      .artist-video-container { height: 400px; border-radius: 30px; }
      .artist-video-overlay { padding: 25px; }
      .artist-section .artist-info h2 { font-size: 2em; }
      .albums-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
      .albums-grid.active, .tracks-list.active { top: 450px; } /* Large screen album/track list position */
      .album-card { border-radius: 15px; }
      .album-card:hover { transform: translateY(-5px); }
      .album-info { padding: 15px 20px; }
      .album-number { font-size: 0.9em; margin-bottom: 5px; }
      .tracks-list { border-radius: 20px; padding: 25px; margin-top: 30px; }
      .track-item { padding: 12px; border-radius: 10px; }
      .track-number { width: 30px; font-size: 1em; }
      .track-info { font-size: 1em; }
      .mini-player { bottom: 20px; right: 20px; border-radius: 15px; padding: 18px; gap: 15px; width: 300px; }
      .mini-player img { width: 50px; height: 50px; border-radius: 8px; }
      .mini-player .track-name { font-size: 1em; }
      .mini-player .artist-name { font-size: 0.9em; }
      .player-controls { gap: 10px; }
      .mini-player .control-button { font-size: 20px; }
      .full-player .control-button { font-size: 32px; margin: 0 10px; }
      .full-player { padding: 25px; }
      .full-player .back-button { top: 25px; left: 25px; padding: 10px 20px;}
      .player-left, .player-right { padding: 25px; }
      .player-right { padding-top: 20px; }
      .full-player-album-art { width: 250px; height: 250px; }
      .progress-container { max-width: 350px; height: 12px; margin: 25px 0; }
      .progress-knob {  width: 18px; height: 18px; top: 50%; transform: translateY(-50%);}
      .time-display { max-width: 350px; font-size: 14px; }
      .lyrics-container { max-height: 60vh; }
      .lyrics-line { padding: 10px 12px; font-size: 1.1em; }
      .lyrics-line.active { font-size: 1.4em;  transform: scale(1.1) translateY(-2px); }
      .full-player .track-name, .full-player .artist-name { margin-bottom: 5px; font-size: 1.5em; }

      /* Full Player Layout */
      .full-player-content { flex-direction: row; }
      .player-left, .player-right { width: 50%; padding: 20px; }
      .player-right { padding-top: 20px; }
      .full-player-album-art { width: 250px; height: 250px; }
      .progress-container { max-width: 350px; }
      .time-display { max-width: 350px; }
      .progress-knob {  right: -5px; }
    }

    @media (max-width: 767px) {
      /* Mobile Styles */
      .full-player-content { flex-direction: column; }
      .player-left, .player-right { width: 100%; padding: 15px; }
      .player-right { padding-top: 30px; }
      .full-player-album-art { width: 180px; height: 180px; }
      .progress-container { max-width: 95%; }
      .time-display { max-width: 95%; }
      .full-player .player-left { border-radius: 20px; padding: 20px; background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
      .full-player .player-controls, .full-player .progress-container, .full-player .time-display { text-shadow: none; }
        .progress-knob { top: 50%; transform: translateY(-50%); }
    }

    /* Animations */
    @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0;} to { transform: translateX(0); opacity: 1;}}
    @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0;} }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOutAndSlideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
     }
    @keyframes subtleFadeIn {
        from { opacity: 0.8; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Animation Classes */
    .slide-out-right { animation: slideOutRight 0.3s ease-in-out both; }
    .slide-in-left { animation: slideInLeft 0.3s ease-in-out both; }
    .slide-in-right { animation: slideInRight 0.3s ease-in-out both, subtleFadeIn 0.2s ease-out 0.3s forwards; }
    .slide-out-left { animation: slideOutLeft 0.3s ease-in-out both; }
    .fade-in { animation: fadeIn 0.3s ease-out both; }
    .fade-out-and-slide-up { animation: fadeOutAndSlideUp 0.3s ease-out forwards; }

    /* 개선된 애니메이션 추가 */
    @keyframes pageSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pageSlideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(-100%); opacity: 0; }
    }

    @keyframes pageFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes pageFadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }


    .slide-page-in { animation: pageSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) both; }
    .slide-page-out { animation: pageSlideOut 0.4s cubic-bezier(0.16, 1, 0.3, 1) both; }
    .fade-page-in { animation: pageFadeIn 0.3s ease-out both; }
    .fade-page-out { animation: pageFadeOut 0.3s ease-in both; }


    /* 미니 플레이어 등장 애니메이션 */
    @keyframes miniPlayerEnter {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .mini-player-enter { animation: miniPlayerEnter 0.3s ease-out; }

  </style>
</head>
<body>
  <!-- Brand -->
  <div class="brand">
    <div class="brand-title">Siri Music<span class="os-version">musicOS 1.0</span></div>
  </div>
  <button class="back-button">← 뒤로가기</button>

  <!-- Main Content -->
  <div class="container">
    <div class="artists-grid"></div>
    <div class="artist-section">
      <div class="artist-video-container">
        <video class="artist-video" autoplay muted loop><source src="" type="video/mp4"></video>
        <div class="artist-video-overlay">
          <div class="artist-info"><h2></h2></div>
        </div>
      </div>
    </div>
    <div class="albums-grid"></div>
    <div class="tracks-list"></div>
  </div>

  <!-- Mini Player -->
  <div class="mini-player">
    <img src="" alt="Current track" class="mini-player-album-art">
    <div class="track-info">
      <div class="track-name"></div>
      <div class="artist-name"></div>
    </div>
    <div class="player-controls">
      <button class="control-button prev-button">⏮</button>
      <button class="control-button play-pause-button">►</button>
      <button class="control-button next-button">⏯</button>
    </div>
  </div>

  <!-- Full Player -->
  <div class="full-player">
    <button class="back-button">← 뒤로가기</button>
    <div class="full-player-content">
      <div class="player-left">
        <img src="" alt="Album art" class="full-player-album-art">
        <h2 class="track-name"></h2>
        <p class="artist-name"></p>
        <div class="progress-container">
            <div class="progress"></div>
             <div class="progress-knob"></div>
        </div>
        <div class="time-display">
          <span class="current-time">0:00</span>
          <span class="total-time">0:00</span>
        </div>
        <div class="player-controls">  <!-- Reordered controls to be below progress bar -->
          <button class="control-button prev-button">⏮</button>
          <button class="control-button play-pause-button">►</button>
          <button class="control-button next-button">⏯</button>
        </div>
      </div>
        <div class="player-right">
        <div class="lyrics-container"></div>
        </div>
    </div>
  </div>

  <script>
    // Music Library Data
   const musicLibrary = {
      artists: [
        {
          name: '뉴진스',
          image: 'http://www.applesodam.kro.kr/music/뉴진스/NewJeans.jpg',
          video: 'http://www.applesodam.kro.kr/music/뉴진스/NewJeans.mp4',
          albums: [{
            name: "NewJeans 2nd EP 'Get Up'",
            cover: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/NewJeans 2nd EP 'Get Up'.jpg",
            tracks: [
              { number: 1, title: 'New Jeans', audio: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/New Jeans.mp3", lyrics: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/New Jeans.lrc" },
              { number: 2, title: 'Super Shy', audio: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/Super Shy.mp3", lyrics: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/Super Shy.lrc" },
              { number: 3, title: 'ETA', audio: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/ETA.mp3", lyrics: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/ETA.lrc" },
              { number: 4, title: 'Cool With You', audio: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/Cool With You.mp3", lyrics: "http://www.applesodam.kro.kr/music/NewJeans/NewJeans 2nd EP 'Get Up'/Cool With You.lrc" },
              { number: 5, title: 'Get Up', audio: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/Get Up.mp3", lyrics: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/Get Up.lrc" },
              { number: 6, title: 'ASAP', audio: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/ASAP.mp3", lyrics: "http://www.applesodam.kro.kr/music/뉴진스/NewJeans 2nd EP 'Get Up'/ASAP.lrc" }
            ]
          }]
        },
        {
          name: '아이브',
          image: 'http://www.applesodam.kro.kr/music/아이브/IVE.jpg',
          video: 'http://www.applesodam.kro.kr/music/아이브/IVE.mp4',
          albums: [{
            name: "IVE EMPATHY - EP",
            cover: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/IVE EMPATHY - EP.jpg",
            tracks: [
              { number: 1, title: 'REBEL HEART', audio: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/REBEL HEART.mp3", lyrics: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/REBEL HEART.lrc" },
              { number: 2, title: 'FLU', audio: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/FLU.mp3", lyrics: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/FLU.lrc" },
              { number: 3, title: 'You Wanna Cry', audio: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/You Wanna Cry.mp3", lyrics: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/You Wanna Cry.lrc" },
              { number: 4, title: 'Thank U', audio: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/Thank U.mp3", lyrics: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/Thank U.lrc" },
              { number: 5, title: 'ATTITUDE', audio: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/ATTITUDE.mp3", lyrics: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/ATTITUDE.lrc" },
              { number: 6, title: 'TKO', audio: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/TKO.mp3", lyrics: "http://www.applesodam.kro.kr/music/아이브/IVE EMPATHY - EP/TKO.lrc" }
            ]
          }]
        }
      ]
    };

    // Cache for images and videos
    const mediaCache = new Map();

    // Function to fetch and cache media
    async function getCachedMedia(url) {
        if (mediaCache.has(url)) {
            return mediaCache.get(url);
        }
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.status} ${response.statusText} for ${url}`);
            }
            const blob = await response.blob();
            const objectURL = URL.createObjectURL(blob);
            mediaCache.set(url, objectURL);
            return objectURL;
        } catch (error) {
            console.error('Media caching error:', error);
            return url; // Fallback to original URL in case of error
        }
    }


    // Global Variables
    let currentArtist = null, currentAlbum = null, currentTrack = null, audio = new Audio(), isPlaying = false, currentLyrics = [], highlightedLyric = null, currentGradientColors = ['#a8b8fc', '#84ccf0'], isDragging = false;
    let isUserScrollingLyrics = false;
    let lyricScrollTimeout;
    let historyStack = [];

    // Initialization
    async function initializeMusicPlayer() {
        await loadArtists(); // Load artists first
        setupEventListeners();
        setupAudioEventListeners();
        audio.volume = 0.5;
        historyStack.push('artists');
    }

    // Load Artists
    async function loadArtists() {
        const artistsGrid = document.querySelector('.artists-grid');
        artistsGrid.innerHTML = '';
        for (const artist of musicLibrary.artists) { // Use for...of loop for async calls in sequence
            const artistCard = await createArtistCard(artist);
            artistsGrid.appendChild(artistCard);
        }
    }


    // Create Artist Card
    async function createArtistCard(artist) {
        const card = document.createElement('div');
        card.className = 'artist-card';
        const cachedImageURL = await getCachedMedia(artist.image); // Cache artist image
        card.innerHTML = `<img src="${cachedImageURL}" class="artist-image" alt="${artist.name}">
                          <div class="artist-name-overlay">${artist.name}</div>`;
        card.addEventListener('click', () => showArtist(artist));
        return card;
    }

    // Show Artist Details
    async function showArtist(artist) {
        currentArtist = artist;
        const artistsGrid = document.querySelector('.artists-grid');
        const artistSection = document.querySelector('.artist-section');
        const albumsGrid = document.querySelector('.albums-grid');

        artistSection.classList.add('active');
        albumsGrid.classList.add('active');
        artistsGrid.classList.add('hidden'); // Artists grid 숨김

        document.querySelector('.back-button').style.display = 'block';

        const artistVideo = document.querySelector('.artist-video');
        const cachedVideoURL = await getCachedMedia(artist.video); // Cache artist video
        artistVideo.src = cachedVideoURL;
        artistVideo.style.display = 'block';
        document.querySelector('.artist-section .artist-info h2').textContent = artist.name;
        loadAlbums(artist);

        if (historyStack[historyStack.length - 1] !== 'artist') {
            historyStack.push('artist');
        }
    }

    // Load Albums
    function loadAlbums(artist) {
        const albumsGrid = document.querySelector('.albums-grid');
        albumsGrid.innerHTML = '';
        artist.albums.forEach((album, index) => albumsGrid.appendChild(createAlbumCard(album, index + 1)));
    }

    // Create Album Card
    async function createAlbumCard(album, albumNumber) {
        const card = document.createElement('div');
        card.className = 'album-card';
        const cachedCoverURL = await getCachedMedia(album.cover); // Cache album cover
        card.innerHTML = `
          <img src="${cachedCoverURL}" class="album-image" alt="${album.name}">
          <div class="album-info">
            <div class="album-number">#${albumNumber}</div>
            <h3>${album.name}</h3>
          </div>`;
        card.addEventListener('click', () => showAlbumTracks(album));
        return card;
    }

    // Show Album Tracks
    async function showAlbumTracks(album) {
        currentAlbum = album;
        const albumsGrid = document.querySelector('.albums-grid');
        const tracksList = document.querySelector('.tracks-list');

        tracksList.classList.add('active');
        albumsGrid.classList.remove('active'); // Albums grid 숨김
        albumsGrid.style.display = 'none'; // display none으로 변경

        document.querySelectorAll('.album-card').forEach(card => card.classList.remove('expanded')); // 앨범 카드 expanded 클래스 제거

        tracksList.innerHTML = '';
        album.tracks.forEach(track => tracksList.appendChild(createTrackItem(track)));
        if (historyStack[historyStack.length - 1] !== 'album') {
            historyStack.push('album');
        }
    }


    // Create Track Item
    function createTrackItem(track) {
        const item = document.createElement('div');
        item.className = 'track-item';
        item.innerHTML = `<span class="track-number">${track.number}</span>
                            <div class="track-info">
                              <div class="track-title">${track.title}</div>
                            </div>`;
        item.addEventListener('click', () => playTrack(track));
        return item;
    }

    // Play Track
    async function playTrack(track) {
        currentTrack = track;
        audio.src = track.audio;
        try {
            await audio.play();
            isPlaying = true;
        } catch (error) {
            console.error('재생 중 오류 발생:', error);
            isPlaying = false;
        }

        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = currentAlbum.cover;
        img.onload = () => {
            const colorThief = new ColorThief();
            const colors = colorThief.getPalette(img, 2);
            currentGradientColors = colors.map(color => `rgb(${color[0]}, ${color[1]}, ${color[2]})`);
            updateFullPlayerBackground();
        };

        updateMiniPlayer();
        updateFullPlayer();
        loadAndDisplayLyrics(track.lyrics);
    }

    // Update Mini Player
    function updateMiniPlayer() {
        const miniPlayer = document.querySelector('.mini-player');
        if (!miniPlayer.style.display || miniPlayer.style.display === 'none') {
            miniPlayer.style.display = 'flex';
            miniPlayer.classList.add('mini-player-enter');
        }
        miniPlayer.querySelector('.mini-player-album-art').src = currentAlbum.cover;
        miniPlayer.querySelector('.track-name').textContent = currentTrack.title;
        miniPlayer.querySelector('.artist-name').textContent = currentArtist.name;
        document.querySelectorAll('.play-pause-button').forEach(button => button.textContent = isPlaying ? '⏸' : '▶');
    }

    // Update Full Player (only when visible)
    function updateFullPlayer() {
        const fullPlayer = document.querySelector('.full-player');
        if (fullPlayer.style.display === 'flex') {
            fullPlayer.querySelector('.track-name').textContent = currentTrack.title;
            fullPlayer.querySelector('.artist-name').textContent = currentArtist.name;
            fullPlayer.querySelector('.full-player-album-art').src = currentAlbum.cover;
            document.querySelectorAll('.play-pause-button').forEach(button => button.textContent = isPlaying ? '⏸' : '▶');
        }
    }

    // Update Full Player Background
    function updateFullPlayerBackground() {
        const fullPlayer = document.querySelector('.full-player');
        fullPlayer.style.transition = 'background 1.2s cubic-bezier(0.4, 0, 0.2, 1)';
        fullPlayer.style.background = `linear-gradient(to bottom right, ${currentGradientColors[0]}, ${currentGradientColors[1]})`;
    }

    // Parse LRC Lyrics
    function parseLRC(lrcContent) {
        const lines = lrcContent.trim().split('\n');
        const lyrics = [];
        const timeRegex = /\[(\d+):(\d+(\.\d+)?)\]/;

        lines.forEach(line => {
            const match = line.match(timeRegex);
            if (match) {
                const minutes = parseInt(match[1]);
                const seconds = parseFloat(match[2]);
                const text = line.replace(timeRegex, '').trim();
                const time = minutes * 60 + seconds;
                if (text) {
                    lyrics.push({ time: time, text: text });
                }
            }
        });

        return lyrics.sort((a, b) => a.time - b.time);
    }

    // Display Lyrics
    function displayLyrics(lyrics) {
        const lyricsContainer = document.querySelector('.lyrics-container');
        lyricsContainer.innerHTML = '';
        lyrics.forEach(line => {
            const lineElement = document.createElement('div');
            lineElement.classList.add('lyrics-line');
            lineElement.dataset.time = line.time;
            lineElement.textContent = line.text;
            lineElement.addEventListener('click', () => {
                audio.currentTime = parseFloat(line.time);
                updateLyrics();
            });
            lyricsContainer.appendChild(lineElement);
        });
    }

    // Load and Display Lyrics
    async function loadAndDisplayLyrics(lyricsUrl) {
        try {
            const response = await fetch(lyricsUrl);
            if (!response.ok) {
                throw new Error(`Failed to fetch lyrics: ${response.status}`);
            }
            const text = await response.text();
            currentLyrics = parseLRC(text);
            displayLyrics(currentLyrics);
            updateLyrics();
        } catch (error) {
            console.error('Error loading lyrics:', error);
            document.querySelector('.lyrics-container').innerHTML = '<div class="lyrics-line">가사를 불러올 수 없습니다.</div>';
            currentLyrics = [];
        }
    }

    // Setup Event Listeners
    function setupEventListeners() {
        document.querySelector('.back-button').addEventListener('click', handleBack);
        document.querySelector('.brand-title').addEventListener('click', goToHome);

        const miniPlayer = document.querySelector('.mini-player');
        miniPlayer.addEventListener('click', () => { if (currentAlbum && currentTrack) showFullPlayer(); });

        const controls = document.querySelectorAll('.player-controls');
        controls.forEach(control => {
            control.addEventListener('click', e => e.stopPropagation());
            control.querySelector('.play-pause-button').addEventListener('click', togglePlayPause);
            control.querySelector('.prev-button').addEventListener('click', playPreviousTrack);
            control.querySelector('.next-button').addEventListener('click', playNextTrack);
        });

        document.querySelector('.full-player .back-button').addEventListener('click', hideFullPlayer);

        const progressContainer = document.querySelector('.progress-container');
        progressContainer.addEventListener('mousedown', startDragging);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDragging);
        progressContainer.addEventListener('touchstart', startDragging, { passive: false });
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', stopDragging);

        const lyricsContainer = document.querySelector('.lyrics-container');
        lyricsContainer.addEventListener('scroll', handleLyricsScroll);
    }

    // Handle Lyrics Scroll
    function handleLyricsScroll() {
        isUserScrollingLyrics = true;
        clearTimeout(lyricScrollTimeout);
        lyricScrollTimeout = setTimeout(() => {
            isUserScrollingLyrics = false;
        }, 3000);
    }

    // Start Dragging Progress
    function startDragging(e) {
        e.preventDefault();
        isDragging = true;
        document.querySelector('.progress-container').classList.add('dragging');
        seekAudio(e);
    }

    // Drag Progress
    function drag(e) {
        e.preventDefault();
        if (isDragging) {
            seekAudio(e);
        }
    }

    // Stop Dragging Progress
    function stopDragging() {
        if (isDragging) {
            isDragging = false;
            document.querySelector('.progress-container').classList.remove('dragging');
        }
    }

    // Setup Audio Event Listeners
    function setupAudioEventListeners() {
        audio.addEventListener('timeupdate', updateProgress);
        audio.addEventListener('ended', () => playNextTrack());
    }

    // Handle Back Button Click
    async function handleBack() {
        historyStack.pop();
        const currentView = historyStack[historyStack.length - 1];

        const backButton = document.querySelector('.back-button');
        const artistsGrid = document.querySelector('.artists-grid');
        const artistSection = document.querySelector('.artist-section');
        const albumsGrid = document.querySelector('.albums-grid');
        const tracksList = document.querySelector('.tracks-list');
        const fullPlayer = document.querySelector('.full-player');

        if (tracksList.classList.contains('active')) {
            tracksList.classList.remove('active');
            albumsGrid.style.display = 'grid'; // 앨범 그리드 다시 표시
            // albumsGrid.classList.add('active'); // 앨범 그리드 애니메이션은 필요시 추가, 현재는 즉시 표시
        } else if (albumsGrid.classList.contains('active') || albumsGrid.style.display === 'grid') { // albumsGrid.style.display 조건 추가
            albumsGrid.classList.remove('active');
            artistSection.classList.remove('active');
            artistsGrid.classList.remove('hidden'); // Artists grid 다시 표시
            albumsGrid.style.display = 'none'; // albumsGrid display none 처리
            artistSection.style.display = 'none'; // artistSection display none 처리
        } else if (artistSection.classList.contains('active')) {
            artistSection.classList.remove('active');
            artistsGrid.classList.remove('hidden');
            artistSection.style.display = 'none';
            albumsGrid.style.display = 'none';
            backButton.style.display = 'none';
        } else if (fullPlayer.style.display === 'flex') {
            hideFullPlayer();
            historyStack.push('full-player');

        }

        if (historyStack.length <= 1 && historyStack[0] === 'artists') {
            goToHome();
            historyStack = ['artists'];
        }
    }


    // Go to Home Page (Reset to Artist Grid)
    function goToHome() {
        document.querySelector('.artist-section').style.display = 'none';
        document.querySelector('.albums-grid').style.display = 'none';
        document.querySelector('.tracks-list').style.display = 'none';
        document.querySelector('.full-player').style.display = 'none';
        document.querySelector('.artists-grid').classList.remove('hidden'); // Artists grid 보이기
        document.querySelector('.back-button').style.display = 'none';

        const artistVideo = document.querySelector('.artist-video');
        artistVideo.style.display = 'none';

        historyStack = ['artists'];
    }

    // Show Full Player
    function showFullPlayer() {
        document.querySelector('.full-player').classList.add('fade-page-in');
        document.querySelector('.full-player').style.display = 'flex';
        document.querySelector('.full-player .full-player-album-art').src = currentAlbum.cover;
        document.querySelector('.full-player .track-name').textContent = currentTrack.title;
        document.querySelector('.full-player .artist-name').textContent = currentArtist.name;

        const miniPlayer = document.querySelector('.mini-player');
        miniPlayer.style.transform = 'translateY(100%)';
        setTimeout(() => {
            miniPlayer.style.display = 'none';
            miniPlayer.style.transform = 'translateY(0)';

            const miniPlayerAlbumArt = document.querySelector('.mini-player-album-art');
            miniPlayerAlbumArt.style.opacity = 0;
            miniPlayerAlbumArt.style.transform = 'scale(0.5)';

            const fullPlayerAlbumArt = document.querySelector('.full-player-album-art');
            fullPlayerAlbumArt.style.opacity = 0;
            fullPlayerAlbumArt.style.transform = 'scale(0.5)';

            setTimeout(() => {
                fullPlayerAlbumArt.style.opacity = 1;
                fullPlayerAlbumArt.style.transform = 'scale(1)';
            }, 50);

        }, 300);


        updateFullPlayerBackground();
        updateLyrics();
         if (historyStack[historyStack.length - 1] !== 'full-player') {
              historyStack.push('full-player');
          }
    }


    // Hide Full Player
    function hideFullPlayer() {
        const fullPlayer = document.querySelector('.full-player');
        fullPlayer.classList.add('fade-page-out');

        const miniPlayer = document.querySelector('.mini-player');

        const fullPlayerAlbumArt = document.querySelector('.full-player-album-art');
        fullPlayerAlbumArt.style.opacity = 0;
        fullPlayerAlbumArt.style.transform = 'scale(0.5)';

        const miniPlayerAlbumArt = document.querySelector('.mini-player-album-art');
        miniPlayerAlbumArt.style.opacity = 0;
        miniPlayerAlbumArt.style.transform = 'scale(0.5)';

        setTimeout(() => {
            fullPlayer.style.display = 'none';
            fullPlayer.classList.remove('fade-page-out');

            miniPlayer.style.display = 'flex';
            miniPlayer.style.transform = 'translateY(0)';


            setTimeout(() => {
                miniPlayerAlbumArt.style.opacity = 1;
                miniPlayerAlbumArt.style.transform = 'scale(1)';
            }, 50);

        }, 300);

      if (historyStack[historyStack.length -1] === 'full-player') {
          historyStack.pop();
      }
    }


    // Toggle Play/Pause
    function togglePlayPause() {
        if (audio.paused) {
            audio.play();
            isPlaying = true;
        } else {
            audio.pause();
            isPlaying = false;
        }
      updateMiniPlayer();
      updateFullPlayer();
      document.querySelectorAll('.play-pause-button').forEach(button => button.textContent = isPlaying ? '⏸' : '▶');
    }

    // Play Previous Track
    function playPreviousTrack() {
      const tracks = currentAlbum.tracks;
      const currentIndex = tracks.findIndex(track => track === currentTrack);
      currentIndex > 0 ? playTrack(tracks[currentIndex - 1]) : playTrack(tracks[tracks.length - 1]);
    }

    // Play Next Track
    function playNextTrack() {
      const tracks = currentAlbum.tracks;
      const currentIndex = tracks.findIndex(track => track === currentTrack);
      currentIndex < tracks.length - 1 ? playTrack(tracks[currentIndex + 1]) : playTrack(tracks[0]);
    }

   // Seek Audio
    function seekAudio(e) {
        if (isDragging) {
            const container = document.querySelector('.progress-container');
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let percent = (clientX - rect.left) / rect.width;
            percent = Math.max(0, Math.min(1, percent));
            audio.currentTime = percent * audio.duration;

            document.querySelector('.progress').style.width = `${percent * 100}%`;
            document.querySelector('.progress-knob').style.left = `${clientX - rect.left}px`;
        }
    }

    // Update Progress Bar and Time Display
    function updateProgress() {
        const progress = document.querySelectorAll('.progress');
        const currentTimeDisplays = document.querySelectorAll('.current-time');
        const totalTimeDisplays = document.querySelectorAll('.total-time');
        const knob = document.querySelector('.progress-knob');

        const percentage = (audio.currentTime / audio.duration) * 100;

        progress.forEach(p => p.style.width = `${percentage}%`);


        if (!isDragging) {
            const progressRect = document.querySelector('.progress-container').getBoundingClientRect();
            knob.style.left = `${(percentage / 100) * progressRect.width}px`;
        }

        currentTimeDisplays.forEach(display => display.textContent = formatTime(audio.currentTime));
        totalTimeDisplays.forEach(display => display.textContent = formatTime(audio.duration));
        updateLyrics();
    }

    // Format Time
    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Update Lyrics Highlighting
    function updateLyrics() {
        if (!currentLyrics.length) return;
        if (isUserScrollingLyrics) return;

        const currentTime = audio.currentTime;
        let nextLyricIndex = -1;

        for (let i = 0; i < currentLyrics.length; i++) {
            if (currentLyrics[i].time > currentTime) {
                nextLyricIndex = i;
                break;
            }
        }

        let currentLyricIndex = nextLyricIndex === -1 ? currentLyrics.length - 1 : nextLyricIndex - 1;


        if (highlightedLyric) {
            highlightedLyric.classList.remove('active');
            highlightedLyric = null;
        }

        if (currentLyricIndex >= 0) {
            const lyricLine = document.querySelector(`.lyrics-line[data-time="${currentLyrics[currentLyricIndex].time}"]`);
            if (lyricLine) {
                lyricLine.classList.add('active');
                highlightedLyric = lyricLine;

                const container = document.querySelector('.lyrics-container');
                const targetPosition = lyricLine.offsetTop - (container.offsetHeight / 2);

                container.scrollTo({
                  top: targetPosition,
                  behavior: 'smooth'
                });

            }
        }
    }


    // Initialize the Player
    document.addEventListener('DOMContentLoaded', initializeMusicPlayer);
  </script>
</body>
</html>
