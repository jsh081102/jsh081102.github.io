<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Siri Music</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
  <style>
    /* General Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; -webkit-tap-highlight-color: transparent; }
    body {
      background: linear-gradient(to bottom right, #f5f7fa, #c3cfe2),
                  radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.05) 100%);
      overflow-x: hidden;
      background-blend-mode: overlay;
    }

    /* Brand & Navigation */
    .brand { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; padding: 15px; display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
    .brand-title { font-size: 20px; color: #333; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px; position: relative; cursor: pointer; /* 홈으로 가기 위해 cursor 추가 */ }
    .os-version { font-size: 11px; color: rgba(0, 0, 0, 0.4); position: absolute; bottom: -0.1px; left: 90px; white-space: nowrap; }

    .back-button {
      position: fixed; top: 50px; left: 10px; background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.9); padding: 8px 16px; border-radius: 25px;
      cursor: pointer; display: none; z-index: 1001; transition: transform 0.3s ease, opacity 0.3s ease;
      font-size: 14px; color: #333; backdrop-filter: blur(10px); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .back-button:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.9); }
    .back-button.show { display: block; animation: fadeIn 0.3s ease-out; }

    /* Main Container */
    .container { max-width: 1200px; margin: 0 auto; padding: 60px 15px 80px; /* mini-player 높이 고려 */ position: relative; }

    /* Artist Grid */
    .artists-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .artists-grid.hidden {
      /* display: none 대신 visibility 사용 고려 또는 height 0으로 애니메이션 */
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      position: absolute; /* 공간 차지하지 않도록 */
      width: 100%; /* 부모 너비 기준 */
    }

    .artist-card { background: rgba(255, 255, 255, 0.15); border-radius: 15px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.2s, background-color 0.2s; cursor: pointer; position: relative; backdrop-filter: blur(10px); }
    .artist-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.25); }
    .artist-image { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; /* 이미지 하단 여백 제거 */ }
    .artist-name-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.6)); color: #fff; font-size: 1.4em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }

    /* Artist Section */
    .artist-section {
      display: none; /* 초기 상태는 none */
      position: relative;
      padding: 15px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      background: rgba(255, 255, 255, 0.05); /* 배경색 추가 */
      border-radius: 15px; /* 일관성을 위해 추가 */
      margin-top: 20px; /* artists-grid와 간격 */
    }
    .artist-section.active {
      display: block; /* 활성화 시 block */
      opacity: 1;
      transform: translateY(0);
    }
    .artist-video-container { position: relative; width: 100%; height: 250px; border-radius: 25px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); background: rgba(0,0,0,0.1); /* 비디오 로딩 중 배경 */ }
    .artist-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; /* 로드 후 보이도록 */ }
    .artist-video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.4) 90%); pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 15px; }
    .artist-video-overlay h2 { color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); font-size: 1.6em; margin: 0; }

    /* Albums Grid */
    .albums-grid {
      display: none; /* 초기 상태 none */
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
      position: relative;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s; /* 약간의 딜레이 */
    }
    .albums-grid.active {
      display: grid; /* 활성화 시 grid */
      opacity: 1;
      transform: translateY(0);
    }
    .album-card { background: rgba(255, 255, 255, 0.15); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.2s, background-color 0.2s; cursor: pointer; backdrop-filter: blur(10px); }
    .album-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.25); }
    .album-image { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; /* 이미지 하단 여백 제거 */ }
    .album-info { padding: 10px 15px; }
    .album-number { color: #999; font-size: 0.8em; margin-bottom: 3px; }

    /* Tracks List */
    .tracks-list {
      display: none; /* 초기 상태 none */
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow-y: auto;
      position: relative;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s; /* 약간의 딜레이 */
      backdrop-filter: blur(10px);
    }
    .tracks-list.active {
      display: block; /* 활성화 시 block */
      opacity: 1;
      transform: translateY(0);
    }
    .track-item { display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 10px; transition: background-color 0.2s; }
    .track-item:hover { background: rgba(255, 255, 255, 0.2); }
    .track-number { width: 25px; color: #999; font-size: 0.9em; flex-shrink: 0; }
    .track-info { flex-grow: 1; font-size: 0.95em; color: #333; margin-left: 10px; } /* 간격 추가 */

    /* Mini Player */
    .mini-player {
      position: fixed;
      bottom: 15px;
      right: 15px;
      left: 15px; /* 왼쪽에도 여백 추가 */
      margin: 0 auto; /* 중앙 정렬 */
      background: rgba(255, 255, 255, 0.25);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      display: none; /* 초기엔 숨김 */
      align-items: center;
      gap: 10px;
      cursor: pointer;
      z-index: 1000;
      width: auto; /* 너비 자동 조정 */
      max-width: 400px; /* 최대 너비 제한 */
      transition: transform 0.3s ease, opacity 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .mini-player img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; flex-shrink: 0; /* 중요: 이미지가 줄어들지 않도록 */
      /* 애니메이션 제거됨: transition: transform 0.5s ease, opacity 0.5s ease; */
    }
    .mini-player .track-info { flex-grow: 1; overflow: hidden; min-width: 0; /* flex 아이템이 내용보다 작아질 수 있도록 */ }
    .mini-player .track-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; color: #333; }
    .mini-player .artist-name { color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.8em; }
    .player-controls { display: flex; align-items: center; gap: 15px; }

    /* Control Buttons */
    .control-button { background: none; border: none; cursor: pointer; padding: 6px; transition: transform 0.2s; color: #555; font-size: 20px; line-height: 1; /* 버튼 높이 일관성 */ }
    .mini-player .control-button { font-size: 20px; }
    .full-player .control-button { font-size: 28px; margin: 0 10px; color: #fff; }
    .control-button:hover { transform: scale(1.1); }
    .control-button:active { transform: scale(0.95); }

    /* Full Player */
    .full-player { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); display: none; z-index: 2000; padding: 20px; overflow: hidden; transition: opacity 0.3s ease; }
    .full-player .back-button { position: absolute; top: 20px; left: 20px; display: block; color: #333; background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); z-index: 2001; /* 다른 요소 위에 오도록 */ }
    .full-player .back-button:active { background: rgba(255, 255, 255, 0.9); }
    .full-player-content { display: flex; flex-direction: column; width: 100%; height: 100%; }
    .player-left, .player-right { flex: none; width: 100%; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .player-right { overflow-y: auto; padding-top: 30px; }
    .full-player-album-art {
      width: 200px; height: 200px; border-radius: 15px; margin-bottom: 15px; object-fit: cover;
      /* 애니메이션 제거됨: transition: transform 0.5s ease, opacity 0.5s ease; */
      /* 대신 fade-in 효과를 위해 transition 추가 */
      transition: opacity 0.3s ease;
      opacity: 0; /* 초기엔 투명 */
    }

    /* Progress Bar */
    .progress-container {
      width: 95%;
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      margin: 20px 0;
      cursor: pointer;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      backdrop-filter: blur(5px);
      -webkit-tap-highlight-color: transparent; /* 터치 시 하이라이트 제거 */
    }
    .progress { height: 100%; background: rgba(255, 255, 255, 0.8); border-radius: 50px; width: 0; transition: width 0.1s linear; pointer-events: none; /* 클릭 이벤트가 progress-container로 가도록 */ }
    .progress-knob {
      position: absolute;
      top: 50%;
      left: 0; /* 초기 위치 */
      transform: translate(-50%, -50%); /* 중앙 정렬 */
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      transition: left 0.1s linear; /* width와 동일하게 linear */
      border: 1px solid rgba(255, 255, 255, 0.5);
      pointer-events: none; /* 클릭 이벤트가 progress-container로 가도록 */
      opacity: 1; /* 항상 보이도록 */
    }
    /* .progress-container:hover .progress-knob, 제거 */
    /* .progress-container.dragging .progress-knob { opacity: 1; } 제거 */
    .time-display { display: flex; justify-content: space-between; width: 95%; color: #fff; font-size: 12px; margin-top: -10px; /* 프로그레스 바와 가깝게 */ padding: 0 5px; }

    /* Lyrics */
    .lyrics-container {
      width: 100%;
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      overflow-y: auto;
      overflow-x: hidden;
      /* max-height 계산 수정: 상단 요소들 높이 고려 */
      max-height: calc(100% - 80px); /* player-right 패딩 등 고려 */
      padding: 15px 0; /* 좌우 패딩 제거 */
      margin-bottom: 20px;
      scroll-behavior: smooth; /* 부드러운 스크롤 */
      -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
    }
    .lyrics-container::-webkit-scrollbar { display: none; } /* 스크롤바 숨김 */
    .lyrics-container { scrollbar-width: none; } /* Firefox 스크롤바 숨김 */
    .lyrics-line {
      padding: 10px 12px;
      margin: 6px 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0.7;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1em;
      color: #f0f0f0;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      line-height: 1.5;
      white-space: pre-line;
    }
    .lyrics-line.active {
      font-size: 1.3em;
      font-weight: bold;
      opacity: 1;
      transform: translateY(-2px) scale(1.03);
      background: rgba(255,255,255,0.25);
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 12px 14px;
      /* animation: lyricHighlight 0.4s ease-in-out; 제거 (transition으로 충분) */
    }
    .lyrics-line:hover { background: rgba(255,255,255,0.15); }
    .full-player .track-name, .full-player .artist-name { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); color: white; text-align: center; margin-bottom: 3px; font-size: 1.2em; padding: 0 10px; /* 너무 길 경우 대비 */ }

    /* Responsive Design */
    @media (min-width: 768px) {
      .brand { padding: 20px 30px; }
      .brand-title { font-size: 24px; gap: 10px; }
      .os-version { font-size: 12px; left: 115px; }
      .back-button { top: 65px; left: 30px; padding: 10px 20px; font-size: 16px; }
      .container { padding: 90px 30px 100px; }
      .artists-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
      .artist-name-overlay { padding: 15px; font-size: 1.6em; }
      .artist-section { padding: 20px; margin-top: 30px; }
      .artist-video-container { height: 350px; border-radius: 30px; }
      .artist-video-overlay { padding: 25px; }
      .artist-video-overlay h2 { font-size: 2em; }
      .albums-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; }
      .album-info { padding: 15px 20px; }
      .tracks-list { border-radius: 20px; padding: 25px; margin-top: 30px; }
      .mini-player { bottom: 20px; right: 20px; left: auto; margin: 0; border-radius: 15px; padding: 18px; gap: 15px; width: auto; max-width: 450px; } /* 오른쪽 정렬 복구 */
      .mini-player img { width: 50px; height: 50px; border-radius: 8px; }
      .full-player { padding: 25px; }
      .full-player-content { flex-direction: row; }
      .player-left, .player-right { width: 50%; padding: 30px; height: calc(100% - 50px); /* 전체 높이 고려 */ }
      .player-right { padding-top: 50px; /* 여유 공간 */ }
      .full-player-album-art { width: clamp(200px, 30vh, 300px); height: clamp(200px, 30vh, 300px); margin-top: 40px; /* 상단 여백 추가 */ }
      .progress-container { max-width: 400px; height: 12px; margin: 25px 0; }
      .progress-knob { width: 18px; height: 18px; }
      .time-display { max-width: 400px; font-size: 14px; margin-top: -15px; }
      .lyrics-container { max-height: calc(100% - 100px); }
    }

    @media (max-width: 767px) {
      /* 모바일에서 full player 레이아웃 조정 */
      .full-player-content { height: 100%; /* 전체 높이 사용 */ }
      .player-left { height: auto; /* 내용에 맞게 조정 */ padding-bottom: 10px; }
      .player-right { height: calc(100% - 350px); /* 대략적인 상단 높이 제외, 조정 필요 */ padding-top: 10px; }
      .full-player-album-art { width: 180px; height: 180px; margin-top: 30px; }
      .progress-container { max-width: 95%; margin: 15px 0; }
      .time-display { max-width: 95%; margin-top: -8px; }
      .lyrics-container { max-height: 100%; padding-bottom: 30px; /* 하단 여유 */}
    }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes miniPlayerEnter { from { transform: translateY(100px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    /* @keyframes lyricHighlight 제거 */
    @keyframes backFade { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-20px); } }
    /* @keyframes albumArtExpand 제거 */

    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .fade-out { animation: fadeOut 0.3s ease-in forwards; }
    .mini-player-enter { animation: miniPlayerEnter 0.3s ease-out forwards; }
    .back-fade { animation: backFade 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div class="brand">
    <div class="brand-title">Siri Music<span class="os-version">musicOS 1.0</span></div>
  </div>
  <button class="back-button">← 뒤로가기</button>

  <div class="container">
    <div class="artists-grid"></div>
    <div class="artist-section">
      <div class="artist-video-container">
        <video class="artist-video" autoplay muted loop playsinline><source src="" type="video/mp4"></video> {/* playsinline 추가 */}
        <div class="artist-video-overlay"><h2></h2></div>
      </div>
      <div class="albums-grid"></div>
    </div>
    <div class="tracks-list"></div>
  </div>

  <div class="mini-player">
    <img src="" alt="Current track" class="mini-player-album-art">
    <div class="track-info">
      <div class="track-name"></div>
      <div class="artist-name"></div>
    </div>
    <div class="player-controls">
      <button class="control-button prev-button" aria-label="Previous track">⏮</button>
      <button class="control-button play-pause-button" aria-label="Play/Pause">⏯</button>
      <button class="control-button next-button" aria-label="Next track">⏭</button>
    </div>
  </div>

  <div class="full-player">
    <button class="back-button">← 뒤로가기</button>
    <div class="full-player-content">
      <div class="player-left">
        <img src="" alt="Album art" class="full-player-album-art">
        <h2 class="track-name"></h2>
        <p class="artist-name"></p>
        <div class="progress-container">
          <div class="progress"></div>
          <div class="progress-knob"></div>
        </div>
        <div class="time-display">
          <span class="current-time">0:00</span>
          <span class="total-time">0:00</span>
        </div>
        <div class="player-controls">
           <button class="control-button prev-button" aria-label="Previous track">⏮</button>
           <button class="control-button play-pause-button" aria-label="Play/Pause">⏯</button>
           <button class="control-button next-button" aria-label="Next track">⏭</button>
        </div>
      </div>
      <div class="player-right">
        <div class="lyrics-container"></div>
      </div>
    </div>
  </div>

  <script>
    // === 개선 사항 반영 ===
    // 1. 미니 플레이어 -> 풀 플레이어 확장 시 앨범 아트 커지는 애니메이션 제거 (CSS 및 JS 수정)
    // 2. 아티스트 선택 시 로딩 지연 개선 (showArtist 함수 비동기 처리 및 preload 로직 추가)
    // =====================

    // Image and Video Cache
    const imageCache = new Map();
    const videoCache = new Map();

    // --- 캐싱 함수 개선 ---
    async function getCachedResource(url, type = 'image') {
        const cache = type === 'video' ? videoCache : imageCache;
        if (cache.has(url)) return cache.get(url);

        try {
            if (type === 'image') {
                const image = new Image();
                image.src = url;
                await new Promise((resolve, reject) => {
                    image.onload = resolve;
                    image.onerror = (err) => reject(new Error(`이미지 로드 실패: ${url}`));
                });
                cache.set(url, image); // 이미지 객체 자체를 캐시
                return image;
            } else if (type === 'video') {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`비디오 가져오기 실패: ${response.status}`);
                const blob = await response.blob();
                const videoURL = URL.createObjectURL(blob);
                cache.set(url, videoURL);
                return videoURL;
            }
        } catch (error) {
            console.error(`${type} 캐싱/로드 실패: ${url}`, error);
            cache.set(url, null); // 실패한 경우 null 저장하여 재시도 방지
            return null;
        }
    }
    const getCachedImage = (url) => getCachedResource(url, 'image');
    const getCachedVideo = (url) => getCachedResource(url, 'video');
    // --- 캐싱 함수 개선 끝 ---


    // Music Library Data (동일)
    const musicLibrary = {
      artists: [
        {
          name: '뉴진스',
          image: 'http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans.jpg',
          video: 'http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans.mp4',
          albums: [{
            name: "NewJeans 2nd EP 'Get Up'",
            cover: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/NewJeans%202nd%20EP%20'Get%20Up'.jpg",
            tracks: [
              { number: 1, title: 'New Jeans', audio: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/New%20Jeans.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/New%20Jeans.lrc" },
              { number: 2, title: 'Super Shy', audio: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/Super%20Shy.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/Super%20Shy.lrc" },
              { number: 3, title: 'ETA', audio: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/ETA.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/ETA.lrc" },
              { number: 4, title: 'Cool With You', audio: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/Cool%20With%20You.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/Cool%20With%20You.lrc" },
              { number: 5, title: 'Get Up', audio: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/Get%20Up.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/Get%20Up.lrc" },
              { number: 6, title: 'ASAP', audio: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/ASAP.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EB%89%B4%EC%A7%84%EC%8A%A4/NewJeans%202nd%20EP%20'Get%20Up'/ASAP.lrc" }
            ]
          }]
        },
        {
          name: '아이브',
          image: 'http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE.jpg',
          video: 'http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE.mp4',
          albums: [{
            name: "IVE SWITCH", // 앨범명 수정 (데이터 확인 필요)
            cover: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/IVE%20SWITCH.jpg", // 경로 수정
            tracks: [
              // 트랙 정보 수정 (데이터 확인 필요)
              { number: 1, title: '해야 (HEYA)', audio: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/%ED%95%B4%EC%95%BC%20(HEYA).mp3", lyrics: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/%ED%95%B4%EC%95%BC%20(HEYA).lrc" },
              { number: 2, title: 'Accendio', audio: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/Accendio.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/Accendio.lrc" },
              { number: 3, title: 'Blue Heart', audio: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/Blue%20Heart.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/Blue%20Heart.lrc" },
              { number: 4, title: 'Ice Queen', audio: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/Ice%20Queen.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/Ice%20Queen.lrc" },
              { number: 5, title: 'WOW', audio: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/WOW.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/WOW.lrc" },
              { number: 6, title: 'RESET', audio: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/RESET.mp3", lyrics: "http://www.applesodam.kro.kr/music/%EC%95%84%EC%9D%B4%EB%B8%8C/IVE%20SWITCH/RESET.lrc" }
            ]
          }]
        }
      ]
    };

    // Global Variables
    let currentArtist = null, currentAlbum = null, currentTrack = null, audio = new Audio(), isPlaying = false, currentLyrics = [], highlightedLyric = null, currentGradientColors = ['#a8b8fc', '#84ccf0'], isDragging = false;
    let isUserScrollingLyrics = false, lyricScrollTimeout, historyStack = ['artists'];
    const colorThief = new ColorThief(); // ColorThief 인스턴스 미리 생성

    // DOM Elements Cache
    const elements = {
        artistsGrid: document.querySelector('.artists-grid'),
        artistSection: document.querySelector('.artist-section'),
        artistVideo: document.querySelector('.artist-video'),
        artistVideoOverlayTitle: document.querySelector('.artist-video-overlay h2'),
        albumsGrid: document.querySelector('.albums-grid'),
        tracksList: document.querySelector('.tracks-list'),
        backButton: document.querySelector('.back-button'),
        brandTitle: document.querySelector('.brand-title'),
        miniPlayer: document.querySelector('.mini-player'),
        miniPlayerArt: document.querySelector('.mini-player-album-art'),
        miniPlayerTrackName: document.querySelector('.mini-player .track-name'),
        miniPlayerArtistName: document.querySelector('.mini-player .artist-name'),
        fullPlayer: document.querySelector('.full-player'),
        fullPlayerBackButton: document.querySelector('.full-player .back-button'),
        fullPlayerArt: document.querySelector('.full-player-album-art'),
        fullPlayerTrackName: document.querySelector('.full-player .track-name'),
        fullPlayerArtistName: document.querySelector('.full-player .artist-name'),
        progressContainer: document.querySelector('.progress-container'),
        progress: document.querySelector('.progress'),
        progressKnob: document.querySelector('.progress-knob'),
        currentTimeDisplay: document.querySelector('.current-time'),
        totalTimeDisplay: document.querySelector('.total-time'),
        lyricsContainer: document.querySelector('.lyrics-container'),
        playPauseButtons: document.querySelectorAll('.play-pause-button'),
        prevButtons: document.querySelectorAll('.prev-button'),
        nextButtons: document.querySelectorAll('.next-button')
    };

    // Initialization
    function initializeMusicPlayer() {
      loadArtists(); // 아티스트 로드 및 프리로딩 시작
      setupEventListeners();
      setupAudioEventListeners();
      audio.volume = 0.5; // 기본 볼륨 설정
    }

    // --- 아티스트 로딩 및 프리로딩 개선 ---
    async function loadArtists() {
        elements.artistsGrid.innerHTML = ''; // 그리드 비우기
        elements.artistsGrid.classList.remove('hidden');
        // elements.artistsGrid.style.display = 'grid'; // CSS에서 관리하므로 제거 가능
        elements.artistSection.classList.remove('active');
        elements.albumsGrid.classList.remove('active');
        elements.tracksList.classList.remove('active');
        elements.backButton.style.display = 'none';

        // Promise.all로 병렬 처리
        const artistCardPromises = musicLibrary.artists.map(async (artist) => {
            // 리소스 프리로딩 시작 (결과 기다리지 않음)
            getCachedImage(artist.image); // 아티스트 이미지
            getCachedVideo(artist.video); // 아티스트 비디오
            if (artist.albums && artist.albums.length > 0) {
                getCachedImage(artist.albums[0].cover); // 첫 앨범 커버
            }
            // 카드 생성
            return createArtistCard(artist);
        });

        const artistCards = await Promise.all(artistCardPromises);
        artistCards.forEach(card => {
            if (card) elements.artistsGrid.appendChild(card);
        });
    }

    // Create Artist Card
    async function createArtistCard(artist) {
      const card = document.createElement('div');
      card.className = 'artist-card';
      // 이미지 캐싱/로드를 기다림
      const artistImage = await getCachedImage(artist.image);
      // 이미지 로드 실패 시 카드 생성 안 함 (또는 플레이스홀더 표시)
      if (!artistImage) return null;

      card.innerHTML = `<img src="${artist.image}" class="artist-image" alt="${artist.name}" loading="lazy"> {/* 레이지 로딩 추가 */}
                        <div class="artist-name-overlay">${artist.name}</div>`;
      card.addEventListener('click', () => showArtist(artist));
      return card;
    }

    // --- 아티스트 상세 보기 로딩 개선 ---
    // Show Artist Details
    async function showArtist(artist) {
        currentArtist = artist;

        // 1. UI 즉시 업데이트
        elements.artistsGrid.classList.add('hidden');
        elements.artistSection.classList.add('active');
        elements.albumsGrid.classList.add('active'); // 앨범 그리드도 바로 활성화
        elements.backButton.style.display = 'block';
        elements.backButton.classList.add('show');
        elements.artistVideoOverlayTitle.textContent = artist.name;

        // 2. 앨범 로딩 시작 (비디오 로딩과 병렬 수행)
        loadAlbums(artist); // 내부적으로 이미지 캐싱 사용

        // 3. 비디오 로딩 및 설정 (백그라운드)
        elements.artistVideo.style.display = 'none'; // 일단 숨김
        getCachedVideo(artist.video).then(videoSrc => {
            if (videoSrc && currentArtist === artist) { // 다른 아티스트로 넘어가지 않았는지 확인
                elements.artistVideo.src = videoSrc;
                elements.artistVideo.style.display = 'block'; // 로드 완료 후 표시
                elements.artistVideo.play().catch(e => console.warn("자동 재생 실패:", e)); // 자동 재생 시도
            }
        });

        // 4. 히스토리 스택 업데이트
        if (historyStack[historyStack.length - 1] !== 'artist') historyStack.push('artist');

        // 스크롤 맨 위로 이동
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Load Albums
    async function loadAlbums(artist) {
        elements.albumsGrid.innerHTML = ''; // 앨범 그리드 비우기
        const albumCardPromises = artist.albums.map((album, index) => createAlbumCard(album, index + 1));
        const albumCards = await Promise.all(albumCardPromises);
        albumCards.forEach(card => {
            if (card) elements.albumsGrid.appendChild(card);
        });
    }

    // Create Album Card
    async function createAlbumCard(album, albumNumber) {
      const card = document.createElement('div');
      card.className = 'album-card';
      const coverImage = await getCachedImage(album.cover); // 이미지 캐싱/로드 기다림
      if (!coverImage) return null;

      card.innerHTML = `
        <img src="${album.cover}" class="album-image" alt="${album.name}" loading="lazy">
        <div class="album-info">
          <div class="album-number">#${albumNumber}</div>
          <h3>${album.name}</h3>
        </div>`;
      card.addEventListener('click', () => showAlbumTracks(album));
      return card;
    }

    // Show Album Tracks
    function showAlbumTracks(album) { // async 제거 가능
      currentAlbum = album;
      elements.albumsGrid.classList.remove('active');
      elements.tracksList.classList.add('active');
      elements.tracksList.innerHTML = ''; // 트랙 리스트 비우기

      // 트랙 아이템 생성 및 추가 (forEach 사용)
      album.tracks.forEach(track => {
          const trackItem = createTrackItem(track);
          elements.tracksList.appendChild(trackItem);
      });

      if (historyStack[historyStack.length - 1] !== 'album') historyStack.push('album');

      // 트랙 리스트 상단으로 스크롤 (부드럽게)
      elements.tracksList.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Create Track Item
    function createTrackItem(track) {
      const item = document.createElement('div');
      item.className = 'track-item';
      item.innerHTML = `<span class="track-number">${track.number}</span>
                        <div class="track-info">
                          <div class="track-title">${track.title}</div>
                        </div>`;
      item.addEventListener('click', () => playTrack(track));
      return item;
    }

    // Play Track
    async function playTrack(track) {
      currentTrack = track;
      audio.src = track.audio;
      isPlaying = false; // 로딩 시작 시 일단 false
      updatePlayPauseButtons(); // 버튼 상태 변경 (로딩 중 표시 가능하면 좋음)

      try {
        // ColorThief 처리 (이미지 캐싱 활용)
        const img = await getCachedImage(currentAlbum.cover);
        if (img) {
            // 메인 스레드 차단 최소화 위해 비동기 처리 고려 (여기선 단순화)
            try {
                const colors = colorThief.getPalette(img, 2);
                currentGradientColors = colors.map(color => `rgb(${color[0]}, ${color[1]}, ${color[2]})`);
                updateFullPlayerBackground(); // 백그라운드 즉시 업데이트
            } catch (e) {
                console.warn("ColorThief 색상 추출 실패:", e);
                // 기본 색상 유지 또는 다른 fallback
            }
        }

        await audio.play(); // 재생 시도
        isPlaying = true; // 재생 성공 시 true
      } catch (error) {
        console.error('재생 오류:', error);
        isPlaying = false;
        // 사용자에게 오류 알림 UI 추가 고려
      } finally {
        updatePlayPauseButtons(); // 최종 버튼 상태 업데이트
        updateMiniPlayer(); // 플레이어 정보 업데이트
        updateFullPlayer(); // 풀 플레이어 정보 업데이트 (열려있을 경우)
        loadAndDisplayLyrics(track.lyrics); // 가사 로드
      }
    }

    // Update Mini Player
    function updateMiniPlayer() {
        if (!currentTrack || !currentAlbum || !currentArtist) return; // 데이터 없으면 실행 안 함

        if (elements.miniPlayer.style.display !== 'flex') {
            elements.miniPlayer.style.display = 'flex';
            elements.miniPlayer.classList.remove('fade-out'); // 혹시 남아있을 수 있는 클래스 제거
            elements.miniPlayer.classList.add('mini-player-enter');
        }
        elements.miniPlayerArt.src = currentAlbum.cover;
        elements.miniPlayerArt.alt = currentAlbum.name;
        elements.miniPlayerTrackName.textContent = currentTrack.title;
        elements.miniPlayerArtistName.textContent = currentArtist.name;
        updatePlayPauseButtons(); // 재생/일시정지 버튼 상태 업데이트
    }

    // Update Full Player
    function updateFullPlayer() {
        // 풀 플레이어가 활성화 상태일 때만 업데이트
        if (elements.fullPlayer.style.display === 'flex' && currentTrack && currentAlbum && currentArtist) {
            elements.fullPlayerTrackName.textContent = currentTrack.title;
            elements.fullPlayerArtistName.textContent = currentArtist.name;
            elements.fullPlayerArt.src = currentAlbum.cover;
            elements.fullPlayerArt.alt = currentAlbum.name;
            // opacity는 showFullPlayer에서 처리하므로 여기서는 불필요
            updatePlayPauseButtons(); // 재생/일시정지 버튼 상태 업데이트
        }
    }

    // Update Full Player Background
    function updateFullPlayerBackground() {
        elements.fullPlayer.style.background = `linear-gradient(to bottom right, ${currentGradientColors[0]}, ${currentGradientColors[1]})`;
    }

    // --- 가사 처리 개선 ---
    // Parse LRC Lyrics
    function parseLRC(lrcContent) {
      const lines = lrcContent.trim().split('\n');
      const lyrics = [];
      const timeRegex = /\[(\d{2,}):(\d{2}(?:\.\d{1,3})?)\]/g; // 여러 타임스탬프 처리 및 밀리초(3자리)까지 지원

      lines.forEach(line => {
        let text = line;
        let match;
        const times = [];

        // 한 줄에 여러 타임스탬프가 있는 경우 처리 ([00:10.1][00:12.5] Text)
        while ((match = timeRegex.exec(line)) !== null) {
          const minutes = parseInt(match[1], 10);
          const seconds = parseFloat(match[2]);
          if (!isNaN(minutes) && !isNaN(seconds)) {
            times.push(minutes * 60 + seconds);
          }
          // 매치된 타임스탬프 부분을 텍스트에서 제거
          text = text.replace(match[0], '');
        }

        text = text.trim();
        // 텍스트가 있고 타임스탬프가 있었던 경우에만 가사 추가
        if (text && times.length > 0) {
            times.forEach(time => {
                lyrics.push({ time, text });
            });
        }
      });

      // 시간 순으로 정렬
      return lyrics.sort((a, b) => a.time - b.time);
    }

    // Display Lyrics
    function displayLyrics(lyrics) {
      elements.lyricsContainer.innerHTML = ''; // 컨테이너 비우기
      if (!lyrics || lyrics.length === 0) {
          elements.lyricsContainer.innerHTML = '<div class="lyrics-line">가사 정보가 없습니다.</div>';
          return;
      }

      const fragment = document.createDocumentFragment(); // 성능 향상 위해 DocumentFragment 사용
      lyrics.forEach(line => {
        const lineElement = document.createElement('div');
        lineElement.classList.add('lyrics-line');
        lineElement.dataset.time = line.time; // data 속성으로 시간 저장
        lineElement.textContent = line.text;
        lineElement.addEventListener('click', () => {
          audio.currentTime = parseFloat(line.time);
          // updateLyrics(); // 클릭 시 즉시 업데이트는 timeupdate 이벤트가 처리하므로 불필요할 수 있음
        });
        fragment.appendChild(lineElement);
      });
      elements.lyricsContainer.appendChild(fragment);
    }

    // Load and Display Lyrics
    async function loadAndDisplayLyrics(lyricsUrl) {
      currentLyrics = []; // 초기화
      highlightedLyric = null; // 하이라이트 초기화
      try {
        const response = await fetch(lyricsUrl);
        if (!response.ok) throw new Error(`가사 가져오기 실패: ${response.status}`);
        const text = await response.text();
        currentLyrics = parseLRC(text);
        displayLyrics(currentLyrics);
        // 초기 가사 하이라이트 (필요 시)
        updateLyrics();
      } catch (error) {
        console.error('가사 로드 오류:', error);
        displayLyrics([]); // 오류 시 가사 없음 메시지 표시
      }
    }
    // --- 가사 처리 개선 끝 ---

    // Setup Event Listeners
    function setupEventListeners() {
      elements.backButton.addEventListener('click', handleBack);
      elements.brandTitle.addEventListener('click', goToHome);

      // Mini Player 클릭 시 Full Player 열기 (컨트롤 버튼 영역 제외)
      elements.miniPlayer.addEventListener('click', (e) => {
          if (!e.target.closest('.player-controls') && currentTrack) {
              showFullPlayer();
          }
      });

      // 모든 컨트롤 버튼에 이벤트 위임 적용 고려 (여기선 개별 유지)
      elements.playPauseButtons.forEach(button => button.addEventListener('click', togglePlayPause));
      elements.prevButtons.forEach(button => button.addEventListener('click', playPreviousTrack));
      elements.nextButtons.forEach(button => button.addEventListener('click', playNextTrack));

      elements.fullPlayerBackButton.addEventListener('click', hideFullPlayer);

      // Progress Bar Interaction
      const handleSeek = (e) => {
        if (isNaN(audio.duration)) return;
        const rect = elements.progressContainer.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let percent = (clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent));
        audio.currentTime = percent * audio.duration;
        updateProgress(); // 드래그 중에도 즉시 업데이트
      };

      const startDragging = (e) => {
          // e.preventDefault(); // 기본 스크롤 방지 (터치 시 필요할 수 있음)
          isDragging = true;
          elements.progressContainer.classList.add('dragging');
          document.body.style.userSelect = 'none'; // 드래그 중 텍스트 선택 방지
          handleSeek(e); // 클릭/터치 시작 위치로 바로 이동
          // 이벤트 리스너 동적 추가/제거
          document.addEventListener('mousemove', drag);
          document.addEventListener('touchmove', drag, { passive: false });
          document.addEventListener('mouseup', stopDragging);
          document.addEventListener('touchend', stopDragging);
      };

      const drag = (e) => {
          if (isDragging) {
              e.preventDefault(); // 스크롤 방지
              handleSeek(e);
          }
      };

      const stopDragging = () => {
          if (isDragging) {
              isDragging = false;
              elements.progressContainer.classList.remove('dragging');
              document.body.style.userSelect = ''; // 텍스트 선택 방지 해제
              // 이벤트 리스너 제거
              document.removeEventListener('mousemove', drag);
              document.removeEventListener('touchmove', drag);
              document.removeEventListener('mouseup', stopDragging);
              document.removeEventListener('touchend', stopDragging);
          }
      };

      elements.progressContainer.addEventListener('mousedown', startDragging);
      elements.progressContainer.addEventListener('touchstart', startDragging, { passive: false }); // passive: false 필수

      elements.lyricsContainer.addEventListener('scroll', handleLyricsScroll);
    }

    // Handle Lyrics Scroll
    function handleLyricsScroll() {
      isUserScrollingLyrics = true;
      clearTimeout(lyricScrollTimeout);
      lyricScrollTimeout = setTimeout(() => {
        isUserScrollingLyrics = false;
        // 스크롤 멈춘 후 현재 위치 기준으로 하이라이트 다시 맞출 필요는 timeupdate에서 처리됨
      }, 1500); // 사용자가 스크롤 멈췄다고 판단하는 시간 (조절 가능)
    }

    // Setup Audio Event Listeners
    function setupAudioEventListeners() {
      audio.addEventListener('timeupdate', () => {
          // Debounce or Throttle 사용 고려 (여기선 requestAnimationFrame 사용)
          requestAnimationFrame(updateProgress);
      });
      audio.addEventListener('ended', playNextTrack);
      audio.addEventListener('loadedmetadata', () => {
          // 메타데이터 로드 완료 시 전체 시간 업데이트
          updateProgress(); // 여기서 duration이 설정됨
      });
      audio.addEventListener('play', () => { isPlaying = true; updatePlayPauseButtons(); });
      audio.addEventListener('pause', () => { isPlaying = false; updatePlayPauseButtons(); });
      audio.addEventListener('error', (e) => {
          console.error("오디오 오류 발생:", audio.error);
          isPlaying = false;
          updatePlayPauseButtons();
          // 사용자에게 오류 알림 표시
      });
    }

    // Handle Back Button Click
    function handleBack() {
        if (historyStack.length <= 1) return; // 초기 상태면 동작 안 함

        const currentView = historyStack.pop();
        const previousView = historyStack[historyStack.length - 1];

        // 현재 뷰 숨기기
        if (currentView === 'full-player') {
            hideFullPlayer(true); // 내부 호출 플래그
        } else if (currentView === 'album') {
            elements.tracksList.classList.remove('active');
        } else if (currentView === 'artist') {
            elements.artistSection.classList.remove('active');
            elements.albumsGrid.classList.remove('active'); // artist 섹션 나갈 때 앨범 그리드도 비활성화
            elements.artistVideo.pause(); // 비디오 정지
            elements.artistVideo.src = ""; // 비디오 소스 제거 (메모리 절약)
        }

        // 이전 뷰 보이기
        if (previousView === 'artists') {
            elements.artistsGrid.classList.remove('hidden');
            elements.backButton.style.display = 'none';
        } else if (previousView === 'artist') {
            // showArtist를 다시 호출할 필요 없이, 이미 DOM에 있는 요소를 활성화
            elements.artistSection.classList.add('active');
            elements.albumsGrid.classList.add('active'); // 앨범 그리드 다시 활성화
            elements.backButton.style.display = 'block';
        } else if (previousView === 'album') {
            // 이미 artist 섹션은 활성화 상태일 것이므로 tracksList만 활성화
            elements.tracksList.classList.add('active');
            elements.backButton.style.display = 'block';
        }
        // Mini player는 full player 닫힐 때 자동으로 관리됨
    }

    // Go to Home Page
    function goToHome() {
      // 모든 상세 뷰 숨기기
      elements.artistSection.classList.remove('active');
      elements.albumsGrid.classList.remove('active');
      elements.tracksList.classList.remove('active');
      hideFullPlayer(true); // 풀 플레이어도 닫기

      // 아티스트 그리드 보이기
      elements.artistsGrid.classList.remove('hidden');
      elements.backButton.style.display = 'none';

      // 비디오 정지 및 소스 제거
      elements.artistVideo.pause();
      elements.artistVideo.src = "";

      historyStack = ['artists']; // 히스토리 초기화
      window.scrollTo({ top: 0, behavior: 'smooth' }); // 맨 위로 스크롤
    }

    // --- 풀 플레이어 표시 애니메이션 개선 ---
    // Show Full Player
    function showFullPlayer() {
        if (!currentTrack) return; // 재생 중인 트랙 없으면 중단

        // 1. 풀 플레이어 표시 및 기본 정보 업데이트
        elements.fullPlayer.style.display = 'flex';
        updateFullPlayer(); // 트랙 이름, 아티스트 이름 설정
        updateFullPlayerBackground(); // 배경색 설정
        elements.fullPlayer.classList.remove('fade-out');
        elements.fullPlayer.classList.add('fade-in');

        // 2. 앨범 아트 즉시 설정 및 fade-in 시작
        elements.fullPlayerArt.src = currentAlbum.cover; // src 설정
        elements.fullPlayerArt.alt = currentAlbum.name;
        // 약간의 딜레이 후 opacity 변경하여 fade-in 효과 주기
        setTimeout(() => {
             elements.fullPlayerArt.style.opacity = 1;
        }, 50); // 짧은 딜레이 (transition 시작 보장)

        // 3. 미니 플레이어 숨기기
        elements.miniPlayer.classList.remove('mini-player-enter');
        elements.miniPlayer.classList.add('fade-out');
        setTimeout(() => {
            elements.miniPlayer.style.display = 'none';
        }, 300); // fade-out 시간과 일치

        // 4. 히스토리 스택 업데이트
        if (historyStack[historyStack.length - 1] !== 'full-player') {
            historyStack.push('full-player');
        }

        // 가사 컨테이너 스크롤 맨 위로 (선택적)
        // elements.lyricsContainer.scrollTo({ top: 0 });
        // 또는 현재 재생 라인으로 스크롤
        if (highlightedLyric && !isUserScrollingLyrics) {
             scrollLyricsToActive();
        }
    }

    // Hide Full Player
    function hideFullPlayer(internalCall = false) { // handleBack에서의 호출 구분
        elements.fullPlayer.classList.remove('fade-in');
        elements.fullPlayer.classList.add('fade-out');

        // 앨범 아트 다시 투명하게 (다음 열릴 때를 위해)
        elements.fullPlayerArt.style.opacity = 0;

        setTimeout(() => {
            elements.fullPlayer.style.display = 'none';
            // 미니 플레이어 표시 (재생 중인 트랙이 있을 경우)
            if (currentTrack) {
                elements.miniPlayer.style.display = 'flex';
                elements.miniPlayer.classList.remove('fade-out'); // 이전 fade-out 제거
                elements.miniPlayer.classList.add('mini-player-enter');
            }
        }, 300); // fade-out 시간과 일치

        // handleBack에서 호출된 게 아니면 history pop
        if (!internalCall && historyStack[historyStack.length - 1] === 'full-player') {
            historyStack.pop();
        }
    }
    // --- 풀 플레이어 애니메이션 개선 끝 ---

    // Toggle Play/Pause
    function togglePlayPause() {
      if (!currentTrack) return; // 재생할 트랙 없으면 무시
      if (audio.readyState >= 2) { // 데이터가 충분히 로드되었는지 확인 (HAVE_CURRENT_DATA 이상)
          if (audio.paused) {
            audio.play().catch(e => console.error("재생 시작 오류:", e));
          } else {
            audio.pause();
          }
      } else {
          console.warn("오디오 데이터 로딩 중... 잠시 후 다시 시도하세요.");
          // 로딩 중임을 사용자에게 알리는 UI 피드백 추가 고려
      }
    }

    // Update Play/Pause Buttons State
    function updatePlayPauseButtons() {
        const icon = isPlaying ? '⏸' : '▶';
        const label = isPlaying ? 'Pause' : 'Play';
        elements.playPauseButtons.forEach(button => {
             button.textContent = icon;
             button.setAttribute('aria-label', label);
        });
    }

    // Play Previous Track
    function playPreviousTrack() {
      if (!currentAlbum) return;
      const tracks = currentAlbum.tracks;
      const currentIndex = tracks.findIndex(t => t === currentTrack);
      // 첫 곡에서 이전 누르면 마지막 곡으로
      const prevIndex = currentIndex > 0 ? currentIndex - 1 : tracks.length - 1;
      playTrack(tracks[prevIndex]);
    }

    // Play Next Track
    function playNextTrack() {
      if (!currentAlbum) return;
      const tracks = currentAlbum.tracks;
      const currentIndex = tracks.findIndex(t => t === currentTrack);
      // 마지막 곡에서 다음 누르면 첫 곡으로
      const nextIndex = currentIndex < tracks.length - 1 ? currentIndex + 1 : 0;
      playTrack(tracks[nextIndex]);
    }

    // Update Progress Bar and Time Display
    function updateProgress() {
        if (isNaN(audio.duration)) {
            // duration이 아직 없을 때 기본값 표시
            elements.progress.style.width = '0%';
            elements.progressKnob.style.left = '0%';
            elements.currentTimeDisplay.textContent = formatTime(0);
            elements.totalTimeDisplay.textContent = formatTime(0);
            return;
        }

        const currentTime = audio.currentTime;
        const duration = audio.duration;
        const percentage = (currentTime / duration) * 100;

        elements.progress.style.width = `${percentage}%`;
        elements.progressKnob.style.left = `${percentage}%`; // Knob 위치 바로 업데이트

        elements.currentTimeDisplay.textContent = formatTime(currentTime);
        elements.totalTimeDisplay.textContent = formatTime(duration);

        // 가사 업데이트는 timeupdate에서 직접 호출
        updateLyrics();
    }

    // Format Time (MM:SS)
    function formatTime(seconds) {
      if (isNaN(seconds) || seconds < 0) return '0:00';
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Update Lyrics Highlighting
    function updateLyrics() {
        if (!currentLyrics.length || elements.fullPlayer.style.display !== 'flex') return; // 가사 없거나 풀 플레이어 아닐 때 중단

        const currentTime = audio.currentTime;
        let activeIndex = -1;

        // 현재 시간에 맞는 가사 라인 찾기 (약간의 오차 허용 가능)
        for (let i = currentLyrics.length - 1; i >= 0; i--) {
            if (currentTime >= currentLyrics[i].time - 0.2) { // 0.2초 정도 미리 활성화
                activeIndex = i;
                break;
            }
        }

        const activeLine = elements.lyricsContainer.querySelector(`.lyrics-line[data-time="${currentLyrics[activeIndex]?.time}"]`);

        // 이전에 활성화된 라인과 현재 라인이 다를 경우에만 업데이트
        if (activeLine && highlightedLyric !== activeLine) {
            if (highlightedLyric) {
                highlightedLyric.classList.remove('active');
            }
            activeLine.classList.add('active');
            highlightedLyric = activeLine;

            // 사용자가 스크롤 중이 아닐 때만 자동 스크롤
            if (!isUserScrollingLyrics) {
                scrollLyricsToActive();
            }
        } else if (activeIndex === -1 && highlightedLyric) {
            // 곡 시작 전이거나 가사 시작 전이면 모든 하이라이트 제거
            highlightedLyric.classList.remove('active');
            highlightedLyric = null;
        }
    }

    // Scroll Lyrics Container to the Active Line
    function scrollLyricsToActive() {
        if (!highlightedLyric) return;
        const container = elements.lyricsContainer;
        const containerRect = container.getBoundingClientRect();
        const lineRect = highlightedLyric.getBoundingClientRect();

        // 화면 중앙에 오도록 스크롤 위치 계산
        const scrollTarget = highlightedLyric.offsetTop - (container.offsetHeight / 2) + (highlightedLyric.offsetHeight / 2);

        container.scrollTo({
            top: scrollTarget,
            behavior: 'smooth'
        });
    }

    // Initialize the Player
    document.addEventListener('DOMContentLoaded', initializeMusicPlayer);

  </script>
</body>
</html>
